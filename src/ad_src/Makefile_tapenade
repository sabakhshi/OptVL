#!Makefile
# Define the required directories
SRC = ..

# Integer, double and real precision (bytes)
TAPENADE_PRECISION = -i4 -dr8 -r8

ALL_RES_FILES =	$(SRC)/aero.f\
				$(SRC)/aoper.f\
				$(SRC)/atpforc.f\
				$(SRC)/asetup.f\
				$(SRC)/aic.f\
				$(SRC)/amake.f\
				$(SRC)/cdcl.f\
				$(SRC)/sgutil.f\
				$(SRC)/amode.f\
				

# intermediate preprocessed files.
PP_DIR = preprocessed_files
PP_FILES = $(addprefix $(PP_DIR)/,$(notdir $(ALL_RES_FILES)))

# ---------------------------------------------------------------------
# If you modify these variables you must check that the necessary intermmidate variables are in AVL_ad_seeds.inc. 
# to check compare the variables in AVL_ad_seeds.inc with the variables in AVL_d.inc and AVL_b.inc.
# you also need to add any new files to `src/build/fileList`
# ====================== Full List of Routines ==================
fullRoutines = "\
	update_surfaces(XYZSCAL,XYZTRAN,ADDINC,XYZLES,CHORDS,MSHBLK,AINCS,XASEC,SASEC,TASEC,CLCDSEC,CLAF)>(ENC,ENV, DXV, CHORDV,CHORD, CHORD1, CHORD2, RLE,RLE1,RLE2, WSTRIP, RV1,RV2,RV,RC,RS,RL, ENSY, ENSZ, ESS, XSREF,YSREF,ZSREF, ENC_D)\
	\
	get_res(GAM, GAM_D, GAM_U, CONVAL, PARVAL, YSYM, ZSYM, ENC, ENV, DXV, CHORDV, RV1, RV2, RV, RC, RS, RL, ENC_D, XYZREF)>(RES, RES_D, RES_U, GAM, GAM_D, GAM_U, VINF, WROT, VINF_A, VINF_B, ALFA, BETA, DELCON, RV1,RV2, RV, RC,DXV, XYZREF, WV_GAM, CDREF, MACH, SRC, SRC_U)\
	\
	VElSUM(GAM, GAM_U, GAM_D, VINF, WROT, WV_GAM)>(VV, VV_U, VV_D, WV, WV_U, WV_D, GAM, GAM_U, GAM_D, VINF, WROT, RV, RV1, RV2) \
	AERO(GAM, GAM_U, GAM_D, VV, VV_U, VV_D, WV, WV_U, WV_D, RC, RV, RV1, RV2, RLE, XYZREF, CHORD, CHORD1, CHORD2, RLE1, RLE2, WSTRIP, ALFA, MACH, VINF, WROT, VINF_A, VINF_B, ENSZ, ENSY, ESS, SREF, CREF, BREF, XSREF,YSREF,ZSREF,DXV, CDREF, SRC, SRC_U)>(\
	CLTOT, CYTOT, CDTOT, CDVTOT, CDITOT\
	CLFF, CYFF, CDFF,\
	CFTOT, \
	CMTOT,\
	CXBAX, CYBAX, CZBAX,\
	CRBAX, CMBAX, CNBAX,\
	CRSAX, CNSAX, \
	SPANEF,\
	CLTOT_D, CYTOT_D, CDTOT_D,\
	CFTOT_D, \
	CMTOT_D, \
	CXTOT_D_BA, CYTOT_D_BA, CZTOT_D_BA, \
    CRTOT_D_BA, CMTOT_D_BA, CNTOT_D_BA, \
	CLTOT_AL, CLTOT_BE, CLTOT_RX, CLTOT_RY, CLTOT_RZ,\
	CDTOT_AL, CDTOT_BE, CDTOT_RX, CDTOT_RY, CDTOT_RZ,\
	CYTOT_AL, CYTOT_BE, CYTOT_RX, CYTOT_RY, CYTOT_RZ,\
	CRTOT_AL, CRTOT_BE, CRTOT_RX, CRTOT_RY, CRTOT_RZ,\
	CMTOT_AL, CMTOT_BE, CMTOT_RX, CMTOT_RY, CMTOT_RZ,\
	CNTOT_AL, CNTOT_BE, CNTOT_RX, CNTOT_RY, CNTOT_RZ,\
	XNP, SM, BB, RR,\
	CRSAX_D, CMSAX_D, CNSAX_D,\
	CXTOT_U_BA, CYTOT_U_BA, CZTOT_U_BA,\
	CRTOT_U_BA, CMTOT_U_BA, CNTOT_U_BA\
	) \
"


default: ad_forward ad_reverse

preprocess_files:

	@echo "Preprocessing all input files for AD..."
	mkdir -p $(PP_DIR)
# make sure the dir is empty
	rm -f $(PP_DIR)/*
	
	python ad_utils/edit_ad_src.py preprocess --files $(ALL_RES_FILES) --output_dir=$(PP_DIR)

clean_fwd: 
# First delete the holding directory if it exists
	rm -fr forward_ad_src
	rm -fr forward_tmp

# Next create the holidng directory:
	mkdir -p forward_ad_src
	mkdir -p forward_tmp

clean_rev:
# First delete the holding directory if it exists
	rm -fr reverse_ad_src
	rm -fr reverse_tmp

# Next create the holidng directory:
	mkdir -p reverse_ad_src
	mkdir -p reverse_tmp

ad_forward: preprocess_files clean_fwd

# The following is the single Tapenade command to run:
	$(TAPENADE_HOME)/bin/tapenade \
	-I $(SRC)/includes \
	-head $(fullRoutines) \
	-tgtvarname %_DIFF \
	-tgtfuncname %_d \
	-forward \
	$(TAPENADE_PRECISION) \
	$(PP_FILES) \
	-O forward_tmp
	
	python ad_utils/edit_ad_src.py forward --input=forward_tmp --output=forward_ad_src
	
ad_reverse: preprocess_files clean_rev

# The following is the single Tapenade command to run:
	$(TAPENADE_HOME)/bin/tapenade \
	-I $(SRC)/includes \
	-head $(fullRoutines) \
	-adjvarname %_DIFF \
	-adjfuncname %_b \
	-reverse \
	$(TAPENADE_PRECISION) \
	$(PP_FILES) \
	-O reverse_tmp
	
	python ad_utils/edit_ad_src.py reverse --input=reverse_tmp --output=reverse_ad_src 

view-html:
	xdg-open forward_ad_src/tapenadehtml/tapenade.html


all:	 default

